<div class="chat-list-container">
  <!-- Header -->
  <div class="chat-header">
    <h1 class="header-title"><i class="fa-regular fa-message m-2"></i>الرسائل</h1>
    <!-- <button class="new-chat-btn" title="محادثة جديدة">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
    </button> -->
  </div>

  <!-- Search Bar -->
  <div class="search-container">
    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/>
      <path d="m21 21-4.35-4.35"/>
    </svg>
    <input 
      type="text" 
      class="search-input" 
      placeholder="ابحث في المحادثات..."
      [(ngModel)]="searchQuery"
      (input)="filterChats()"
    />
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>جاري التحميل...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <path d="M12 8v4M12 16h.01"/>
    </svg>
    <p>{{ error }}</p>
    <button class="retry-btn" (click)="loadChats()">حاول مرة أخرى</button>
  </div>

  <!-- Chat List -->
  <div class="chats-list" *ngIf="!loading && !error && filteredChats.length > 0">
    <div 
      *ngFor="let chat of filteredChats; trackBy: trackByChat" 
      class="chat-item" 
      (click)="onChatClick(chat.id)"
      [class.active]="isActive(chat)">
      <!-- Avatar -->
      <div class="chat-avatar">
        <img 
          *ngIf="getChatImage(chat)" 
          [src]="getChatImage(chat)" 
          [alt]="getChatName(chat)"
        />
        <div *ngIf="!getChatImage(chat)" class="avatar-placeholder">
          {{ getChatName(chat).charAt(0).toUpperCase() }}
        </div>
        <!-- Online status indicator for 1-on-1 chats -->
        <ng-container *ngIf="chat.participants && chat.participants.length === 2">
          <ng-container *ngFor="let participant of chat.participants">
            <span 
              *ngIf="participant.userId !== currentUserId && isUserOnline(participant.userId)" 
              class="online-status"
              title="متصل الآن"
            ></span>
          </ng-container>
        </ng-container>
      </div>

      <!-- Chat Info -->
      <div class="chat-info">
        <div class="chat-header-row">
          <div class="name-row">
            <h3 class="chat-name">{{ getChatName(chat) }}</h3>
            <!-- Listing Badge -->
            <span *ngIf="chat.listingId" class="listing-badge" title="مرتبط بإعلان">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              إعلان #{{chat.listingId}}
            </span>
          </div>
          <span class="chat-time">{{ getTimeAgo(chat.lastMessage?.sentAt) }}</span>
        </div>
        <div class="chat-message-row">
          <p class="last-message">{{ getLastMessage(chat) }}</p>
          <span *ngIf="getUnreadCount(chat) > 0" class="unread-badge">
            {{ getUnreadCount(chat) }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && !error && filteredChats.length === 0" class="empty-container">
    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
    <h3>لا توجد محادثات</h3>
  </div>
</div>
