<div class="container-fluid profile-container" dir="rtl">
    <!-- Cover Image -->
    <div class="row">
        <div class="col-12 p-0">
            <div class="cover-image-container">
                <img src="/images/profile/gray-cover.jpg" alt="Cover Image" class="cover-image">
            </div>
        </div>
    </div>


    <div class="container position-relative" style="margin-top: -50px;">
        <div class="row align-items-end mb-4">
            <div class="col-auto">
                <div class="profile-image-container position-relative d-inline-block">

                    <img [src]="profile.photo || '/images/profile/profile-image.jpg'" alt="Profile Picture"
                        class="profile-image rounded-circle border border-4 border-white cursor-pointer"
                        (click)="openImageModal()"
                        onerror="this.src='https://placehold.co/150x150/3b82f6/ffffff?text=User'">

                    <div *ngIf="isVerified" class="verified-badge standard" title="موثق" data-bs-toggle="tooltip">
                        <i class="bi bi-patch-check-fill"></i>
                    </div>

                </div>
            </div>
            <div class="col">
                <h1 class="mb-0 fw-bold text-dark d-flex align-items-center gap-2">
                    {{ profile.fullName }}
                </h1>
            </div>
        </div>


        <!-- About Me Section -->
        <div class="card border-0 shadow-sm mb-4 rounded-4">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title fw-bold mb-0">نبذة عني</h5>
                    <div>
                        <button *ngIf="isOwnProfile" class="btn btn-outline-secondary btn-sm rounded-3 px-3"
                            routerLink="/profile/edit">تعديل</button>
                        <button *ngIf="!isOwnProfile" class="btn btn-primary btn-sm rounded-3 px-3 ms-2">
                            <i class="bi bi-chat-dots me-1 ms-1"></i> إرسال رسالة
                        </button>
                        <button *ngIf="!isOwnProfile" class="btn btn-outline-danger btn-sm rounded-3 px-3"
                            (click)="openReportModal()">
                            <i class="bi bi-flag me-1 ms-1"></i> إبلاغ عن المستخدم
                        </button>
                    </div>
                </div>
                <div class="mb-4">
                    <h6 class="text-muted small text-uppercase mb-2">السيرة الذاتية</h6>
                    <p class="card-text text-secondary leading-relaxed">{{ profile.bio }}</p>
                </div>
                <div class="mb-4">
                    <h6 class="text-muted small text-uppercase mb-2">البريد الإلكتروني</h6>
                    <div class="d-flex align-items-center text-dark">
                        <i class="bi bi-envelope me-2 ms-2"></i>
                        <span>{{ profile.email }}</span>
                    </div>
                </div>
                <div class="mb-4" *ngIf="isOwnProfile">
                    <h6 class="text-muted small text-uppercase mb-2">رقم الهاتف</h6>
                    <div class="d-flex align-items-center text-dark">
                        <i class="bi bi-telephone me-2 ms-2"></i>
                        <span dir="ltr">{{ profile.phoneNumber }}</span>
                    </div>
                </div>
                <div class="mb-4">
                    <h6 class="text-muted small text-uppercase mb-2">الوظيفة</h6>
                    <div class="d-flex align-items-center text-dark">
                        <i class="bi bi-briefcase me-2 ms-2"></i>
                        <span>{{ profile.job }}</span>
                    </div>
                </div>
                <div class="mb-0">
                    <h6 class="text-muted small text-uppercase mb-2">الجامعة</h6>
                    <div class="d-flex align-items-center text-dark">
                        <i class="bi bi-mortarboard me-2 ms-2"></i>
                        <span>{{ university }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preferences Summary Section -->
        <div class="card border-0 shadow-sm mb-4 rounded-4" *ngIf="hasPreferences">
            <div class="card-body p-4">
                <h5 class="card-title fw-bold mb-3">ملخص التفضيلات</h5>
                <div class="mb-4">
                    <h6 class="text-muted small text-uppercase mb-2">ميزانية السكن</h6>
                    <div class="d-flex align-items-center text-dark fw-medium">
                        <span class="me-1 ms-1">$</span>
                        <span>{{ preferences.minimumBudget }} - {{ preferences.maximumBudget }} / شهرياً</span>
                    </div>
                </div>
                <div class="mb-4">
                    <h6 class="text-muted small text-uppercase mb-2">الأماكن المفضلة</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge bg-light text-dark border rounded-pill px-3 py-2 fw-normal">
                            <i class="bi bi-geo-alt me-1 ms-1"></i> {{ preferences.city }}
                        </span>
                    </div>
                </div>
                <div class="mb-0">
                    <h6 class="text-muted small text-uppercase mb-2">نمط الحياة</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <span *ngFor="let tag of lifestyleTags"
                            class="badge bg-light text-dark border rounded-pill px-3 py-2 fw-normal">
                            <i class="bi bi-tag me-1 ms-1"></i> {{ tag }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Listings Section -->
        <div class="container mt-5 mb-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold mb-0 text-dark">اعلانات {{ profile.fullName }}</h3>
                <button *ngIf="isOwnProfile" class="btn rounded-pill px-4 shadow-sm add-listing-btn"
                    routerLink="/listings/add">
                    <i class="fa-solid fa-plus"></i> إضافة إعلان
                </button>
            </div>
            <div *ngIf="listings.length > 0; else noListings" class="row g-4">
                <div class="col-md-6 col-lg-4" *ngFor="let listing of listings">
                    <div class="card h-100 border-0 shadow-sm rounded-4 overflow-hidden listing-card">
                        <div class="position-relative">
                            <img [src]="getSafeImageUrl(listing.listingPhotos[0]?.url)" [alt]="listing.title"
                                class="listing-image" onerror="this.src='https://placehold.co/600x400?text=No+Image'" />

                            <!-- Price Badge -->
                            <div class="position-absolute top-0 end-0 m-3">
                                <span class="badge bg-white text-dark shadow-sm rounded-pill px-3 py-2">
                                    {{ listing.monthlyPrice }} ج.م. / شهرياً
                                </span>
                            </div>

                            <!-- Status Badge -->
                            <div class="position-absolute top-0 start-0 m-3" *ngIf="isOwnProfile">
                                <span [ngClass]="getStatusBadgeClass(listing.moderationStatus)"
                                    class="badge shadow-sm rounded-pill px-3 py-2 cursor-pointer"
                                    (click)="showModerationDetails(listing)">
                                    {{ getStatusLabel(listing.moderationStatus) }}
                                    <span *ngIf="listing.isFlagged">⚠️</span>
                                </span>
                            </div>
                        </div>

                        <div class="card-body p-4">
                            <h5 class="card-title fw-bold mb-2 text-truncate">{{ listing.title }}</h5>
                            <div class="d-flex align-items-center text-muted mb-3 small">
                                <i class="bi bi-geo-alt me-1 ms-1"></i> {{ listing.city }}
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                <small class="text-muted">
                                    <i class="fa-regular fa-clock"></i> {{ listing.createdAt | date:'mediumDate' }}
                                </small>
                                <button class="btn listing-details-btn" [routerLink]="['/listings', listing.id]">
                                    التفاصيل <i class="bi bi-arrow-left ms-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <ng-template #noListings>
                <div class="text-center py-5 bg-light rounded-4">
                    <i class="bi bi-house-slash display-4 text-muted mb-3"></i>
                    <p class="lead text-muted mb-0">لم يقم هذا المستخدم بنشر أي إعلانات بعد.</p>
                </div>
            </ng-template>
        </div>
    </div>
</div>

<!-- Moderation Details Modal -->
<div *ngIf="selectedListing" class="modal-overlay">
    <div class="modal-dialog">
        <h3>حالة الإعلان</h3>

        <div class="modal-section">
            <p>الحالة الحالية:</p>
            <span [ngClass]="getStatusBadgeClass(selectedListing.moderationStatus)" class="status-badge">
                {{ getStatusLabel(selectedListing.moderationStatus) }}
            </span>
        </div>

        <div *ngIf="selectedListing.moderationNote" class="modal-note">
            <p>ملاحظات المشرف:</p>
            <p>{{ selectedListing.moderationNote }}</p>
        </div>

        <div *ngIf="selectedListing.isFlagged" class="modal-flag">
            <p>تم الإبلاغ عن هذا الإعلان:</p>
            <p>{{ selectedListing.flagReason }}</p>
        </div>

        <div class="modal-footer">
            <button (click)="selectedListing = null" class="btn-close">
                إغلاق
            </button>
        </div>
    </div>
</div>