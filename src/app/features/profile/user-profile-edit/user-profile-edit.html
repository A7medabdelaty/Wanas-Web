<div class="page-container" dir="rtl">
    
    <!-- Header -->
    <div class="page-header">
        <h1>تعديل الملف الشخصي</h1>
        <p>قم بتحديث بياناتك الشخصية وتفضيلات السكن.</p>
    </div>

    <!-- Basic Information Section -->
    <div class="section-card">
        <div class="card-header">
            <h2>البيانات الأساسية</h2>
            <p>إدارة تفاصيل ملفك الشخصي.</p>
        </div>

        <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="profile-form">
            
            <!-- Avatar & Name -->
            <div class="avatar-row">
                <!-- Avatar -->
                <div class="avatar-section">
                    <label>الصورة الشخصية</label>
                    <div class="avatar-wrapper">
                        <div class="avatar-image-container">
                            <img [src]="photoPreview || 'assets/images/default-avatar.png'" alt="Profile" class="avatar-image">
                        </div>
                        <button type="button" class="upload-btn" (click)="fileInput.click()">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </button>
                        <input #fileInput type="file" class="hidden" (change)="onFileSelected($event)" accept="image/*">
                    </div>
                </div>

                <!-- Name Fields -->
                <div class="fields-column">
                    <div class="form-row">
                        <div class="form-group">
                            <label>الاسم الكامل</label>
                            <input type="text" formControlName="fullName" class="form-control" 
                                   [class.invalid]="profileForm.get('fullName')?.invalid && profileForm.get('fullName')?.touched"
                                   placeholder="الاسم الكامل">
                            <div *ngIf="profileForm.get('fullName')?.invalid && profileForm.get('fullName')?.touched" class="error-message">
                                <span *ngIf="profileForm.get('fullName')?.errors?.['required']">الاسم الكامل مطلوب</span>
                                <span *ngIf="profileForm.get('fullName')?.errors?.['minlength']">الاسم يجب أن يكون 3 أحرف على الأقل</span>
                                <span *ngIf="profileForm.get('fullName')?.errors?.['maxlength']">الاسم يجب ألا يتجاوز 100 حرف</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" formControlName="email" class="form-control disabled" placeholder="example@email.com">
                        </div>
                    </div>

                    <div class="form-row">
                         <div class="form-group">
                            <label>العمر</label>
                            <input type="number" formControlName="age" class="form-control"
                                   [class.invalid]="profileForm.get('age')?.invalid && profileForm.get('age')?.touched"
                                   placeholder="25">
                            <div *ngIf="profileForm.get('age')?.invalid && profileForm.get('age')?.touched" class="error-message">
                                <span *ngIf="profileForm.get('age')?.errors?.['min']">العمر يجب أن يكون 18 عاماً على الأقل</span>
                                <span *ngIf="profileForm.get('age')?.errors?.['max']">العمر يجب ألا يتجاوز 100 عام</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>رقم الهاتف</label>
                            <input type="tel" formControlName="phoneNumber" class="form-control"
                                   [class.invalid]="profileForm.get('phoneNumber')?.invalid && profileForm.get('phoneNumber')?.touched"
                                   placeholder="01xxxxxxxxx">
                            <div *ngIf="profileForm.get('phoneNumber')?.invalid && profileForm.get('phoneNumber')?.touched" class="error-message">
                                <span *ngIf="profileForm.get('phoneNumber')?.errors?.['pattern']">صيغة رقم الهاتف غير صحيحة (يجب أن يبدأ بـ 01)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bio -->
            <div class="form-group">
                <label>نبذة عنك</label>
                <textarea formControlName="bio" rows="4" class="form-control textarea"
                          [class.invalid]="profileForm.get('bio')?.invalid && profileForm.get('bio')?.touched"
                          placeholder="اكتب نبذة مختصرة عن نفسك..."></textarea>
                <p class="char-count">{{ getBioCharCount() }}/500 حرف</p>
            </div>

            <!-- Actions -->
            <div class="form-actions">
                <button type="submit" [disabled]="loading" class="btn btn-primary">
                    {{ loading ? 'جاري الحفظ...' : 'حفظ التغييرات' }}
                </button>
            </div>

             <!-- Feedback Messages -->
            <div *ngIf="successMessage" class="alert alert-success">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                {{ successMessage }}
            </div>
            <div *ngIf="errorMessage" class="alert alert-error">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span [innerHTML]="errorMessage"></span>
            </div>

        </form>
    </div>

    <!-- Preferences Section (Embedded) -->
    <app-preference-edit></app-preference-edit>

</div>
