<div class="section-card" dir="rtl">
    <div class="card-header">
        <h2><i class="fa-solid fa-house m-2"></i>تفضيلات السكن</h2>
        <p>هذه التفضيلات تساعدنا في العثور على شريك السكن المثالي لك.</p>
    </div>

    <form [formGroup]="preferenceForm" (ngSubmit)="onSubmit()" class="preference-form">
        
        <!-- Demographics Section -->
        <div class="section-block">
            <h3>التفضيلات الديموغرافية</h3>
            
            <!-- Age Fields (in their own grid) -->
            <div class="form-grid">
                <div class="form-group">
                    <label>الحد الأدنى للعمر</label>
                    <input type="number" formControlName="minimumAge" class="form-control"
                           [class.invalid]="preferenceForm.get('minimumAge')?.invalid && preferenceForm.get('minimumAge')?.touched"
                           placeholder="مثال: 20">
                    <div *ngIf="preferenceForm.get('minimumAge')?.invalid && preferenceForm.get('minimumAge')?.touched" class="error-message">
                        <span *ngIf="preferenceForm.get('minimumAge')?.errors?.['required']">الحد الأدنى للعمر مطلوب</span>
                        <span *ngIf="preferenceForm.get('minimumAge')?.errors?.['min']">الحد الأدنى للعمر يجب أن يكون 18 عاماً على الأقل</span>
                        <span *ngIf="preferenceForm.get('minimumAge')?.errors?.['max']">الحد الأدنى للعمر يجب ألا يتجاوز 100 عام</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>الحد الأقصى للعمر</label>
                    <input type="number" formControlName="maximumAge" class="form-control"
                           [class.invalid]="preferenceForm.get('maximumAge')?.invalid && preferenceForm.get('maximumAge')?.touched"
                           placeholder="مثال: 35">
                    <div *ngIf="preferenceForm.get('maximumAge')?.invalid && preferenceForm.get('maximumAge')?.touched" class="error-message">
                        <span *ngIf="preferenceForm.get('maximumAge')?.errors?.['required']">الحد الأقصى للعمر مطلوب</span>
                        <span *ngIf="preferenceForm.get('maximumAge')?.errors?.['min']">الحد الأقصى للعمر يجب أن يكون 18 عاماً على الأقل</span>
                        <span *ngIf="preferenceForm.get('maximumAge')?.errors?.['max']">الحد الأقصى للعمر يجب ألا يتجاوز 100 عام</span>
                    </div>
                </div>
            </div>
            
            <!-- Age Range Validation (appears below age fields) -->
            <div *ngIf="preferenceForm.errors?.['ageRangeInvalid'] && (preferenceForm.get('minimumAge')?.touched || preferenceForm.get('maximumAge')?.touched)" class="error-message" style="margin-top: 0.5rem;">
                الحد الأدنى للعمر يجب أن يكون أقل من أو يساوي الحد الأقصى
            </div>
            
            <!-- Gender Field (in its own grid) -->
            <div class="form-grid" style="margin-top: 1rem;">
                <div class="form-group">
                    <label>الجنس المفضل</label>
                    <div class="custom-select-container" [class.open]="openDropdown === 'gender'">
                        <div class="custom-select-trigger" (click)="toggleDropdown('gender')"
                             [class.invalid]="preferenceForm.get('gender')?.invalid && preferenceForm.get('gender')?.touched">
                            <span>{{ getLabel('gender', genderOptions) }}</span>
                            <div class="arrow">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                        </div>
                        <div class="custom-options" *ngIf="openDropdown === 'gender'">
                            <div class="custom-option"
                                 *ngFor="let option of genderOptions"
                                 [class.selected]="preferenceForm.get('gender')?.value === option.value"
                                 (click)="selectOption('gender', option.value)">
                                {{ option.label }}
                            </div>
                        </div>
                    </div>
                    <div *ngIf="preferenceForm.get('gender')?.invalid && preferenceForm.get('gender')?.touched" class="error-message">
                        <span *ngIf="preferenceForm.get('gender')?.errors?.['required']">الجنس المفضل مطلوب</span>
                    </div>
                </div>
            </div>
        </div>

        <hr class="divider">

        <!-- Budget & Location -->
        <div class="section-block">
             <h3>الميزانية والموقع</h3>
             <div class="form-grid">
                <div class="form-group">
                    <label>المدينة</label>
                    <input type="text" formControlName="city" class="form-control"
                           [class.invalid]="preferenceForm.get('city')?.invalid && preferenceForm.get('city')?.touched"
                           placeholder="مثال: القاهرة">
                    <div *ngIf="preferenceForm.get('city')?.invalid && preferenceForm.get('city')?.touched" class="error-message">
                        <span *ngIf="preferenceForm.get('city')?.errors?.['required']">المدينة المفضلة مطلوبة</span>
                        <span *ngIf="preferenceForm.get('city')?.errors?.['minlength']">المدينة يجب أن تكون حرفين على الأقل</span>
                        <span *ngIf="preferenceForm.get('city')?.errors?.['maxlength']">المدينة يجب ألا تتجاوز 50 حرفاً</span>
                    </div>
                </div>
                 <div class="grid-2-col">
                    <div class="form-group">
                        <label>أقل ميزانية</label>
                        <input type="number" formControlName="minimumBudget" class="form-control"
                               [class.invalid]="preferenceForm.get('minimumBudget')?.invalid && preferenceForm.get('minimumBudget')?.touched"
                               placeholder="الحد الأدنى">
                        <div *ngIf="preferenceForm.get('minimumBudget')?.invalid && preferenceForm.get('minimumBudget')?.touched" class="error-message">
                            <span *ngIf="preferenceForm.get('minimumBudget')?.errors?.['required']">الحد الأدنى للميزانية مطلوب</span>
                            <span *ngIf="preferenceForm.get('minimumBudget')?.errors?.['min']">الميزانية يجب أن تكون أكبر من 0</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>أقصى ميزانية</label>
                        <input type="number" formControlName="maximumBudget" class="form-control"
                               [class.invalid]="preferenceForm.get('maximumBudget')?.invalid && preferenceForm.get('maximumBudget')?.touched"
                               placeholder="الحد الأقصى">
                        <div *ngIf="preferenceForm.get('maximumBudget')?.invalid && preferenceForm.get('maximumBudget')?.touched" class="error-message">
                            <span *ngIf="preferenceForm.get('maximumBudget')?.errors?.['required']">الحد الأقصى للميزانية مطلوب</span>
                            <span *ngIf="preferenceForm.get('maximumBudget')?.errors?.['min']">الميزانية يجب أن تكون أكبر من 0</span>
                        </div>
                    </div>
                 </div>
             </div>
             <div *ngIf="preferenceForm.errors?.['budgetRangeInvalid'] && (preferenceForm.get('minimumBudget')?.touched || preferenceForm.get('maximumBudget')?.touched)" class="error-message" style="margin-top: 0.5rem;">
                الحد الأدنى للميزانية يجب أن يكون أقل من أو يساوي الحد الأقصى
            </div>
        </div>

        <hr class="divider">
        
        <!-- Lifestyle Section -->
        <div class="form-grid">
            <div class="form-group">
                <label>نظام النوم</label>
                <div class="custom-select-container" [class.open]="openDropdown === 'sleepSchedule'">
                    <div class="custom-select-trigger" (click)="toggleDropdown('sleepSchedule')"
                         [class.invalid]="preferenceForm.get('sleepSchedule')?.invalid && preferenceForm.get('sleepSchedule')?.touched">
                        <span>{{ getLabel('sleepSchedule', sleepScheduleOptions) }}</span>
                        <div class="arrow">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                    </div>
                    <div class="custom-options" *ngIf="openDropdown === 'sleepSchedule'">
                        <div class="custom-option"
                             *ngFor="let option of sleepScheduleOptions"
                             [class.selected]="preferenceForm.get('sleepSchedule')?.value === option.value"
                             (click)="selectOption('sleepSchedule', option.value)">
                            {{ option.label }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>العادات الاجتماعية</label>
                <div class="custom-select-container" [class.open]="openDropdown === 'socialLevel'">
                    <div class="custom-select-trigger" (click)="toggleDropdown('socialLevel')"
                         [class.invalid]="preferenceForm.get('socialLevel')?.invalid && preferenceForm.get('socialLevel')?.touched">
                        <span>{{ getLabel('socialLevel', socialLevelOptions) }}</span>
                        <div class="arrow">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                    </div>
                    <div class="custom-options" *ngIf="openDropdown === 'socialLevel'">
                        <div class="custom-option"
                             *ngFor="let option of socialLevelOptions"
                             [class.selected]="preferenceForm.get('socialLevel')?.value === option.value"
                             (click)="selectOption('socialLevel', option.value)">
                            {{ option.label }}
                        </div>
                    </div>
                </div>
            </div>
             <div class="form-group">
                <label>تحمل الضوضاء</label>
                <div class="custom-select-container" [class.open]="openDropdown === 'noiseToleranceLevel'">
                    <div class="custom-select-trigger" (click)="toggleDropdown('noiseToleranceLevel')"
                         [class.invalid]="preferenceForm.get('noiseToleranceLevel')?.invalid && preferenceForm.get('noiseToleranceLevel')?.touched">
                        <span>{{ getLabel('noiseToleranceLevel', noiseToleranceOptions) }}</span>
                        <div class="arrow">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                    </div>
                    <div class="custom-options" *ngIf="openDropdown === 'noiseToleranceLevel'">
                        <div class="custom-option"
                             *ngFor="let option of noiseToleranceOptions"
                             [class.selected]="preferenceForm.get('noiseToleranceLevel')?.value === option.value"
                             (click)="selectOption('noiseToleranceLevel', option.value)">
                            {{ option.label }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr class="divider">

        <!-- Habits & Rules -->
        <div class="form-grid">
            <div class="preference-item">
                <div class="preference-info">
                    <h3>التدخين</h3>
                    <p>هل التدخين مسموح؟</p>
                </div>
                <div class="preference-control">
                     <div class="custom-select-container" [class.open]="openDropdown === 'smoking'">
                        <div class="custom-select-trigger" (click)="toggleDropdown('smoking')"
                             [class.invalid]="preferenceForm.get('smoking')?.invalid && preferenceForm.get('smoking')?.touched">
                            <span>{{ getLabel('smoking', allowOrNotOptions) }}</span>
                            <div class="arrow">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                        </div>
                        <div class="custom-options" *ngIf="openDropdown === 'smoking'">
                            <div class="custom-option"
                                 *ngFor="let option of allowOrNotOptions"
                                 [class.selected]="preferenceForm.get('smoking')?.value === option.value"
                                 (click)="selectOption('smoking', option.value)">
                                {{ option.label }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
             <div class="preference-item">
                <div class="preference-info">
                    <h3>الحيوانات الأليفة</h3>
                    <p>هل الحيوانات الأليفة مسموحة؟</p>
                </div>
                <div class="preference-control">
                     <div class="custom-select-container" [class.open]="openDropdown === 'pets'">
                        <div class="custom-select-trigger" (click)="toggleDropdown('pets')"
                             [class.invalid]="preferenceForm.get('pets')?.invalid && preferenceForm.get('pets')?.touched">
                            <span>{{ getLabel('pets', allowOrNotOptions) }}</span>
                            <div class="arrow">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                        </div>
                        <div class="custom-options" *ngIf="openDropdown === 'pets'">
                            <div class="custom-option"
                                 *ngFor="let option of allowOrNotOptions"
                                 [class.selected]="preferenceForm.get('pets')?.value === option.value"
                                 (click)="selectOption('pets', option.value)">
                                {{ option.label }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
             <div class="preference-item">
                <div class="preference-info">
                    <h3>الزيارات</h3>
                    <p>هل الزيارات مسموحة؟</p>
                </div>
                <div class="preference-control">
                     <div class="custom-select-container" [class.open]="openDropdown === 'visits'">
                        <div class="custom-select-trigger" (click)="toggleDropdown('visits')"
                             [class.invalid]="preferenceForm.get('visits')?.invalid && preferenceForm.get('visits')?.touched">
                            <span>{{ getLabel('visits', allowOrNotOptions) }}</span>
                            <div class="arrow">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                        </div>
                        <div class="custom-options" *ngIf="openDropdown === 'visits'">
                            <div class="custom-option"
                                 *ngFor="let option of allowOrNotOptions"
                                 [class.selected]="preferenceForm.get('visits')?.value === option.value"
                                 (click)="selectOption('visits', option.value)">
                                {{ option.label }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
             <div class="preference-item">
                <div class="preference-info">
                    <h3>المبيت</h3>
                    <p>هل مبيت الضيوف مسموح؟</p>
                </div>
                <div class="preference-control">
                     <div class="custom-select-container" [class.open]="openDropdown === 'overnightGuests'">
                        <div class="custom-select-trigger" (click)="toggleDropdown('overnightGuests')"
                             [class.invalid]="preferenceForm.get('overnightGuests')?.invalid && preferenceForm.get('overnightGuests')?.touched">
                            <span>{{ getLabel('overnightGuests', allowOrNotOptions) }}</span>
                            <div class="arrow">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                        </div>
                        <div class="custom-options" *ngIf="openDropdown === 'overnightGuests'">
                            <div class="custom-option"
                                 *ngFor="let option of allowOrNotOptions"
                                 [class.selected]="preferenceForm.get('overnightGuests')?.value === option.value"
                                 (click)="selectOption('overnightGuests', option.value)">
                                {{ option.label }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="preference-item">
                <div class="preference-info">
                    <h3>الأطفال</h3>
                    <p>هل وجود الأطفال مسموح؟</p>
                </div>
                <div class="preference-control">
                     <div class="custom-select-container" [class.open]="openDropdown === 'children'">
                        <div class="custom-select-trigger" (click)="toggleDropdown('children')"
                             [class.invalid]="preferenceForm.get('children')?.invalid && preferenceForm.get('children')?.touched">
                            <span>{{ getLabel('children', allowOrNotOptions) }}</span>
                            <div class="arrow">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                        </div>
                        <div class="custom-options" *ngIf="openDropdown === 'children'">
                            <div class="custom-option"
                                 *ngFor="let option of allowOrNotOptions"
                                 [class.selected]="preferenceForm.get('children')?.value === option.value"
                                 (click)="selectOption('children', option.value)">
                                {{ option.label }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr class="divider">

        <!-- Job & Education -->
        <div class="section-block">
            <h3>العمل والدراسة</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>الوظيفة</label>
                    <input type="text" formControlName="job" class="form-control" placeholder="مثال: مهندس برمجيات">
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" formControlName="isStudent" id="isStudent" class="checkbox">
                    <label for="isStudent">أنا طالب</label>
                </div>
            </div>

            <div *ngIf="preferenceForm.get('isStudent')?.value" class="student-details">
                <div class="form-group">
                    <label>الجامعة</label>
                    <input type="text" formControlName="university" class="form-control" placeholder="اسم الجامعة">
                </div>
                <div class="form-group">
                    <label>التخصص</label>
                    <input type="text" formControlName="major" class="form-control" placeholder="مجال الدراسة">
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="form-actions">
            <button type="submit" [disabled]="loading" class="btn rounded-pill submit-btn">
                {{ loading ? 'جاري الحفظ...' : 'حفظ التفضيلات' }}
            </button>
            <button type="button" (click)="loadPreferences()" class="btn rounded-pill cancel-btn">
                تراجع عن التغييرات
            </button>
        </div>

        <!-- Feedback Messages -->
        <div *ngIf="successMessage" class="alert alert-success">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            {{ successMessage }}
        </div>
        <div *ngIf="errorMessage" class="alert alert-error">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            {{ errorMessage }}
        </div>

    </form>
</div>