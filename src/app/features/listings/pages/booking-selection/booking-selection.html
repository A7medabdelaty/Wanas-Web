<div class="booking-selection-page">
  <div class="container py-4">
    @if (loading) {
      <div class="loading-container">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">ุฌุงุฑู ุงูุชุญููู...</span>
        </div>
      </div>
    } @else if (listing) {
      <!-- Header Section -->
      <div class="booking-header">
        <button class="btn-back" (click)="cancel()">
          <i class="bi bi-arrow-right"></i>
        </button>
        <div class="header-content">
          <h1 class="listing-title">{{ listing.title }}</h1>
          <p class="listing-location">
            <i class="bi bi-geo-alt"></i>
            {{ listing.city }} - {{ listing.address }}
          </p>
        </div>
      </div>

      <!-- Instructions -->
      <div class="instructions-card">
        <i class="bi bi-info-circle-fill"></i>
        <p>ุงุฎุชุฑ ุงูุฃุณุฑูุฉ ุงูุชู ุชุฑุบุจ ูู ุญุฌุฒูุง. ุนูุฏ ุงุฎุชูุงุฑ ุฌููุน ุงูุฃุณุฑูุฉ ูู ุบุฑูุฉ ูุงุญุฏุฉุ ุณูุชู ุงุญุชุณุงุจ ุณุนุฑ ุงูุบุฑูุฉ ูุงููุฉ ุชููุงุฆูุงู.</p>
      </div>

      <!-- Reservation Details -->
      <div class="reservation-details-card">
        <h3>๐ ุชูุงุตูู ุงูุญุฌุฒ</h3>
        
        <!-- Duration Selector -->
        <div class="duration-selector">
          <label class="section-label">ุงุฎุชุฑ ูุฏุฉ ุงูุญุฌุฒ</label>
          <div class="duration-options">
            <label class="duration-option" [class.selected]="selectedDuration === 30">
              <input type="radio" name="duration" [value]="30" 
                     [(ngModel)]="selectedDuration"
                     (change)="onDurationChange(30)">
              <div class="option-content">
                <span class="duration-label">ุดูุฑ ูุงูู (30 ููู)</span>
                <span class="duration-price">100% ูู ุงูุณุนุฑ ุงูุดูุฑู</span>
              </div>
            </label>
            <label class="duration-option" [class.selected]="selectedDuration === 15">
              <input type="radio" name="duration" [value]="15"
                     [(ngModel)]="selectedDuration"
                     (change)="onDurationChange(15)">
              <div class="option-content">
                <span class="duration-label">ูุตู ุดูุฑ (15 ููู)</span>
                <span class="duration-price">50% ูู ุงูุณุนุฑ ุงูุดูุฑู</span>
              </div>
            </label>
          </div>
        </div>

        <!-- Check-in Date -->
        <div class="date-input-group">
          <label>ุชุงุฑูุฎ ุชุณุฌูู ุงููุตูู</label>
          <input type="date" 
                 class="form-control"
                 [min]="minCheckInDate"
                 (change)="onCheckInChange($event)">
        </div>

        <!-- Auto-calculated Check-out -->
        @if (checkOutDate) {
          <div class="checkout-display">
            <label>ุชุงุฑูุฎ ุงููุบุงุฏุฑุฉ (ูุญุณูุจ ุชููุงุฆูุงู):</label>
            <span class="checkout-date">{{ checkOutDate | date:'mediumDate':'':'ar-EG' }}</span>
          </div>
        }
      </div>

      <!-- Rooms Grid -->
      <div class="rooms-grid">
        @for (room of rooms; track room.id) {
          <div class="room-card" [class.fully-selected]="isRoomFullySelected(room)">
            <div class="room-header">
              <h3 class="room-title">{{ room.roomNumber }}</h3>
              @if (isRoomFullySelected(room)) {
                <span class="room-badge">
                  <i class="bi bi-check-circle-fill"></i>
                  ุญุฌุฒ ุบุฑูุฉ ูุงููุฉ
                </span>
              } @else if (getSelectedBedsInRoom(room) > 0) {
                <span class="beds-selected-badge">
                  {{ getSelectedBedsInRoom(room) }} ูู {{ room.beds.length }} ุฃุณุฑูุฉ
                </span>
              }
            </div>

            <div class="beds-list">
              @for (bed of room.beds; track bed.id) {
                <label class="bed-checkbox" [class.selected]="isBedSelected(bed.id)">
                  <input 
                    type="checkbox" 
                    [checked]="isBedSelected(bed.id)"
                    (change)="toggleBed(bed.id)"
                    [disabled]="!bed.isAvailable">
                  <div class="bed-content">
                    <i class="bi bi-hospital-bed"></i>
                    <span class="bed-name">{{ bed.bedNumber }}</span>
                    @if (!bed.isAvailable) {
                      <span class="unavailable-badge">ูุญุฌูุฒ</span>
                    }
                  </div>
                  <span class="checkmark">
                    <i class="bi bi-check-lg"></i>
                  </span>
                </label>
              }
            </div>

            <div class="room-pricing">
              @if (isRoomFullySelected(room)) {
                <span class="price-label">ุณุนุฑ ุงูุบุฑูุฉ:</span>
                <span class="price-value">{{ room.roomPrice }} ุฌ.ู</span>
              } @else {
                <span class="price-label">ุณุนุฑ ุงูุณุฑูุฑ:</span>
                <span class="price-value">{{ room.pricePerBed }} ุฌ.ู</span>
              }
            </div>
          </div>
        }
      </div>

      <!-- Summary Panel (Fixed at bottom) -->
      @if (selectedBedIds.size > 0) {
        <div class="summary-panel">
          <div class="summary-content">
            <div class="summary-breakdown">
              <h3 class="summary-title">ููุฎุต ุงูุญุฌุฒ</h3>
              @for (item of getBookingBreakdown(); track $index) {
                <div class="breakdown-item">
                  <span class="item-description">
                    {{ item.name }} 
                    @if (item.quantity > 1) {
                      <span class="quantity">({{ item.quantity }})</span>
                    }
                  </span>
                  <span class="item-price">
                    @if (item.quantity > 1) {
                      <span class="calculation">{{ item.quantity }} ร {{ item.unitPrice }}</span>
                    }
                    <span class="total">{{ item.totalPrice }} ุฌ.ู</span>
                  </span>
                </div>
              }
              <div class="total-amount">
                <span class="total-label">ุงูุฅุฌูุงูู:</span>
                <span class="total-value">{{ calculateTotal() }} ุฌ.ู</span>
              </div>
            </div>
            <div class="summary-actions">
              <button class="btn btn-cancel" (click)="cancel()">
                ุฅูุบุงุก
              </button>
              <button class="btn btn-confirm" (click)="confirmBooking()">
                <i class="bi bi-check-circle me-2"></i>
                ุชุฃููุฏ ุงูุญุฌุฒ
              </button>
            </div>
          </div>
        </div>
      }
    }
  </div>
</div>
