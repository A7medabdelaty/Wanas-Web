<div class="container mt-4 mb-5" dir="rtl">
  <div class="card-header p-4">
      <h2 class="mb-0 fw-bold">إضافة وحدة جديدة</h2>
      <p class="mb-0 opacity-75 mt-1">قم بملء البيانات التالية لإضافة وحدتك السكنية</p>
    </div>
  <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
    <div class="card-body p-4 p-lg-5 bg-light-subtle">
      <form [formGroup]="listingForm" (ngSubmit)="onSubmit()">
        <!-- Basic Info Section -->
        <div class="section-card mb-4">
          <h3 class="mb-4 pb-4 section-title fw-bold border-bottom pb-2">
            <i class="fa-solid fa-circle-info"></i> المعلومات الأساسية
          </h3>
          <div class="row g-4">
            <div class="col-md-6">
              <label class="form-label fw-medium">عنوان الإعلان</label>
              <input
                type="text"
                class="form-control form-control-lg"
                formControlName="title"
                placeholder="مثال: شقة رائعة في وسط المدينة"
                (input)="scrollTextToEnd($event)"
              />
              @if (listingForm.get('title')?.errors && (listingForm.get('title')?.dirty || listingForm.get('title')?.touched)) {
                @if (listingForm.get('title')?.errors?.['required']) {
                  <div class="text-danger small mt-1">هذا الحقل مطلوب</div>
                } @else if (listingForm.get('title')?.errors?.['maxlength']) {
                  <div class="text-danger small mt-1">يجب ألا يتجاوز العنوان 150 حرفاً</div>
                } @else if (listingForm.get('title')?.errors?.['pattern']) {
                  <div class="text-danger small mt-1">العنوان يجب أن يكون نصاً مناسباً ويجب أن يحتوي على أحرف ويمكن أن يحتوي على أرقاماً</div>
                }
              }
            </div>
            <div class="col-md-6">
              <label class="form-label fw-medium">المدينة</label>
              <input
                type="text"
                class="form-control form-control-lg"
                formControlName="city"
                placeholder="اسم المدينة"
                (input)="scrollTextToEnd($event)"
              />
              @if (listingForm.get('city')?.errors && (listingForm.get('city')?.dirty || listingForm.get('city')?.touched)) {
                @if (listingForm.get('city')?.errors?.['required']) {
                  <div class="text-danger small mt-1">هذا الحقل مطلوب</div>
                } @else if (listingForm.get('city')?.errors?.['maxlength']) {
                  <div class="text-danger small mt-1">يجب ألا يتجاوز اسم المدينة 50 حرفاً</div>
                } @else if (listingForm.get('city')?.errors?.['pattern']) {
                  <div class="text-danger small mt-1">اسم المدينة يجب أن يحتوي على أحرف فقط</div>
                }
              }
            </div>
            <div class="col-md-12">
              <label class="form-label fw-medium">العنوان بالتفصيل</label>
              <input
                type="text"
                class="form-control form-control-lg"
                formControlName="address"
                placeholder="اسم الشارع، رقم المبنى..."
                (input)="scrollTextToEnd($event)"
              />
              @if (listingForm.get('address')?.errors && (listingForm.get('address')?.dirty || listingForm.get('address')?.touched)) {
                @if (listingForm.get('address')?.errors?.['required']) {
                  <div class="text-danger small mt-1">هذا الحقل مطلوب</div>
                } @else if (listingForm.get('address')?.errors?.['maxlength']) {
                  <div class="text-danger small mt-1">يجب ألا يتجاوز العنوان 200 حرفاً</div>
                } @else if (listingForm.get('address')?.errors?.['pattern']) {
                  <div class="text-danger small mt-1">العنوان يجب أن يحتوي على أحرف وأرقام ورموز مسموحة فقط</div>
                }
              }
            </div>
            <div class="col-md-6">
              <label class="form-label fw-medium">السعر الشهري (ج.م)</label>
              <input
                type="number"
                class="form-control form-control-lg"
                formControlName="monthlyPrice"
                inputmode="numeric"
                min="1"
                (keydown)="onNumericKeydown($event, 'monthlyPrice')"
                (input)="onNumericTyping($event, 'monthlyPrice')"
              />
              @if (numericTypingInvalid['monthlyPrice']) {
                <div class="text-danger small mt-1">يجب إدخال رقم موجب فقط</div>
              } @else if (listingForm.get('monthlyPrice')?.errors && (listingForm.get('monthlyPrice')?.dirty || listingForm.get('monthlyPrice')?.touched)) {
                @if (listingForm.get('monthlyPrice')?.errors?.['required']) {
                  <div class="text-danger small mt-1">هذا الحقل مطلوب</div>
                } @else if (listingForm.get('monthlyPrice')?.errors?.['min'] || listingForm.get('monthlyPrice')?.errors?.['pattern']) {
                  <div class="text-danger small mt-1">يجب إدخال رقم موجب فقط</div>
                }
              }
            </div>
            <div class="col-md-6">
              <label class="form-label fw-medium">الطابق</label>
              <input type="number" class="form-control form-control-lg" formControlName="floor" inputmode="numeric" min="1" (keydown)="onNumericKeydown($event, 'floor')" (input)="onNumericTyping($event, 'floor')" />
              @if (numericTypingInvalid['floor']) {
                <div class="text-danger small mt-1">يجب إدخال رقم موجب فقط</div>
              } @else if (listingForm.get('floor')?.errors && (listingForm.get('floor')?.dirty || listingForm.get('floor')?.touched)) {
                @if (listingForm.get('floor')?.errors?.['required']) {
                  <div class="text-danger small mt-1">هذا الحقل مطلوب</div>
                } @else if (listingForm.get('floor')?.errors?.['min'] || listingForm.get('floor')?.errors?.['pattern']) {
                  <div class="text-danger small mt-1">يجب إدخال رقم موجب فقط</div>
                }
              }
            </div>
            <div class="col-md-6">
              <label class="form-label fw-medium">المساحة (م²)</label>
              <input
                type="number"
                class="form-control form-control-lg"
                formControlName="areaInSqMeters"
                inputmode="numeric"
                min="1"
                (keydown)="onNumericKeydown($event, 'areaInSqMeters')"
                (input)="onNumericTyping($event, 'areaInSqMeters')"
              />
              @if (numericTypingInvalid['areaInSqMeters']) {
                <div class="text-danger small mt-1">يجب إدخال رقم موجب فقط</div>
              } @else if (listingForm.get('areaInSqMeters')?.errors && (listingForm.get('areaInSqMeters')?.dirty || listingForm.get('areaInSqMeters')?.touched)) {
                @if (listingForm.get('areaInSqMeters')?.errors?.['required']) {
                  <div class="text-danger small mt-1">هذا الحقل مطلوب</div>
                } @else if (listingForm.get('areaInSqMeters')?.errors?.['min'] || listingForm.get('areaInSqMeters')?.errors?.['pattern']) {
                  <div class="text-danger small mt-1">يجب إدخال رقم موجب فقط</div>
                }
              }
            </div>
            <div class="col-md-6">
              <label class="form-label fw-medium">عدد الحمامات</label>
              <input
                type="number"
                class="form-control form-control-lg"
                formControlName="totalBathrooms"
                inputmode="numeric"
                min="1"
                (keydown)="onNumericKeydown($event, 'totalBathrooms')"
                (input)="onNumericTyping($event, 'totalBathrooms')"
              />
              @if (numericTypingInvalid['totalBathrooms']) {
                <div class="text-danger small mt-1">يجب إدخال رقم موجب فقط</div>
              } @else if (listingForm.get('totalBathrooms')?.errors && (listingForm.get('totalBathrooms')?.dirty || listingForm.get('totalBathrooms')?.touched)) {
                @if (listingForm.get('totalBathrooms')?.errors?.['required']) {
                  <div class="text-danger small mt-1">هذا الحقل مطلوب</div>
                } @else if (listingForm.get('totalBathrooms')?.errors?.['min'] || listingForm.get('totalBathrooms')?.errors?.['pattern']) {
                  <div class="text-danger small mt-1">يجب إدخال رقم موجب فقط</div>
                }
              }
            </div>
          </div>
        </div>

        <!-- Amenities Section -->
        <div class="section-card mb-4">
          <h3 class="mb-4 pb-4 section-title fw-bold border-bottom pb-2">
            <i class="fa-regular fa-house"></i>المميزات والمرافق
          </h3>
          <div class="row gap-5 justify-content-around">
            <div class="col-md-4">
              <div class="form-check form-switch custom-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  formControlName="hasElevator"
                  id="hasElevator"
                />
                <label class="form-check-label fw-medium mx-1" for="hasElevator">يوجد مصعد</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check form-switch custom-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  formControlName="hasKitchen"
                  id="hasKitchen"
                />
                <label class="form-check-label fw-medium mx-1" for="hasKitchen">يوجد مطبخ</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check form-switch custom-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  formControlName="hasInternet"
                  id="hasInternet"
                />
                <label class="form-check-label fw-medium mx-1" for="hasInternet">يوجد إنترنت</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check form-switch custom-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  formControlName="hasAirConditioner"
                  id="hasAirConditioner"
                />
                <label class="form-check-label fw-medium mx-1" for="hasAirConditioner"
                  >يوجد تكييف</label
                >
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check form-switch custom-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  formControlName="hasFans"
                  id="hasFans"
                />
                <label class="form-check-label fw-medium mx-1" for="hasFans">يوجد مراوح</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check form-switch custom-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  formControlName="isPetFriendly"
                  id="isPetFriendly"
                />
                <label class="form-check-label fw-medium mx-1" for="isPetFriendly"
                  >يسمح بالحيوانات الأليفة</label
                >
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check form-switch custom-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  formControlName="isSmokingAllowed"
                  id="isSmokingAllowed"
                />
                <label class="form-check-label fw-medium mx-1" for="isSmokingAllowed"
                  >يسمح بالتدخين</label
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Rooms Section -->
        <div class="section-card mb-4">
          <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
            <h3 class="section-title fw-bold mb-0">
              <i class="fa-solid fa-door-open"></i> الغرف
            </h3>
            <button
              type="button"
              class="btn btn-custom-add py-2"
              (click)="addRoom()"
            >
              <i class="bi bi-plus-circle me-2"></i> إضافة غرفة جديدة
            </button>
          </div>

          <ng-container formArrayName="rooms">
            <div
              *ngFor="let room of rooms.controls; let i = index"
              [formGroupName]="i"
              class="mb-4"
            >
              <div class="card border shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                  <h5 class="mb-0 fw-bold room-title">غرفة {{ i + 1 }}</h5>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger rounded-pill"
                    (click)="removeRoom(i)"
                    *ngIf="rooms.length > 1"
                  >
                    <i class="bi bi-trash"></i> حذف الغرفة
                  </button>
                </div>
                <div class="card-body">
                  <div class="row g-5 align-items-end">
                    <div class="col-md-6">
                      <label class="form-label fw-medium">سعر السرير (ج.م)</label>
                      <input type="number" class="form-control form-control-lg price-bed-input" formControlName="pricePerBed" inputmode="numeric" min="1" (keydown)="onRoomNumericKeydown($event, i, 'pricePerBed')" (input)="onRoomNumericTyping($event, i, 'pricePerBed')" />
                      @if (roomNumericTypingInvalid[i]?.['pricePerBed']) {
                        <div class="text-danger small mt-1">يجب إدخال رقم موجب فقط</div>
                      } @else if (room.get('pricePerBed')?.errors && (room.get('pricePerBed')?.dirty || room.get('pricePerBed')?.touched)) {
                        @if (room.get('pricePerBed')?.errors?.['required']) {
                          <div class="text-danger small mt-1">هذا الحقل مطلوب</div>
                        } @else if (room.get('pricePerBed')?.errors?.['min'] || room.get('pricePerBed')?.errors?.['pattern']) {
                          <div class="text-danger small mt-1">يجب إدخال رقم موجب فقط</div>
                        }
                      }
                    </div>
                    <div class="col-md-4">
                      <div class="form-check form-switch custom-switch mb-6">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          formControlName="hasAirConditioner"
                          [id]="'roomAC' + i"
                        />
                        <label class="form-check-label fw-medium mx-2" [for]="'roomAC' + i"
                          >تكييف خاص بالغرفة</label
                        >
                      </div>
                    </div>
                  </div>

                  <!-- Beds Sub-section -->
                  <div class="mt-4 p-3 bg-light rounded-3 border">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h6 class="text-muted mb-0 fw-bold">الأسرة ({{ getBeds(i).length }})</h6>
                      <button
                        type="button"
                        class="btn btn-sm btn-custom-add rounded-pill"
                        (click)="addBed(i)"
                      >
                        <i class="bi bi-plus-lg"></i> إضافة سرير
                      </button>
                    </div>

                    <div formArrayName="beds" class="row g-2">
                      <div
                        *ngFor="let bed of getBeds(i).controls; let j = index"
                        [formGroupName]="j"
                        class="col-auto"
                      >
                        <div
                          class="bed-item d-flex align-items-center justify-content-between bg-white border rounded-pill px-3 py-2 shadow-sm"
                        >
                          <div class="form-check form-switch m-0 d-flex align-items-center gap-2 custom-switch small-switch">
                            <input
                              class="form-check-input m-0"
                              type="checkbox"
                              formControlName="isAvailable"
                              aria-label="Is Available"
                            />
                            <label
                              class="form-check-label small fw-bold text-secondary mb-0 cursor-pointer"
                              >متاح</label
                            >
                          </div>
                          <button
                            class="btn btn-link text-danger p-0 ms-3 d-flex align-items-center"
                            type="button"
                            (click)="removeBed(i, j)"
                            title="حذف السرير"
                          >
                            <i class="bi bi-x-circle-fill fs-5"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </div>

        <!-- Description Section -->
        <div class="section-card mb-4">
          <h3 class="mb-4 pb-4 section-title fw-bold border-bottom pb-2">
            <i class="fa-solid fa-pen"></i> الوصف
          </h3>
          <div class="mb-4">
            <div class="d-flex justify-content-end mb-2">
              <button
                type="button"
                class="btn btn-custom-add py-2"
                (click)="generateDescription()"
                [disabled]="isGeneratingDescription"
              >
                <span
                  *ngIf="isGeneratingDescription"
                  class="spinner-border spinner-border-sm me-1"
                  role="status"
                  aria-hidden="true"
                ></span>
                <i class="bi bi-magic me-1" *ngIf="!isGeneratingDescription"></i>
                {{
                  isGeneratingDescription
                    ? 'جاري التوليد...'
                    : 'توليد وصف باستخدام الذكاء الاصطناعي'
                }}
              </button>
            </div>
            <textarea
              class="form-control form-control-lg description-textarea"
              formControlName="description"
              rows="6"
              placeholder="اكتب وصفاً تفصيلياً للوحدة أو استخدم زر التوليد التلقائي..."
              (input)="scrollTextToEnd($event)"
            ></textarea>
            @if (listingForm.get('description')?.errors && (listingForm.get('description')?.dirty || listingForm.get('description')?.touched)) {
              @if (listingForm.get('description')?.errors?.['required']) {
                <div class="text-danger small mt-1">هذا الحقل مطلوب</div>
              } @else if (listingForm.get('description')?.errors?.['maxlength']) {
                <div class="text-danger small mt-1">يجب ألا يتجاوز الوصف 2000 حرفاً</div>
              } @else if (listingForm.get('description')?.errors?.['pattern']) {
                <div class="text-danger small mt-1">الوصف يجب أن يكون نصاً مناسباً ويمكن أن يحتوي أرقاماً ورموزاً</div>
              }
            }
          </div>
        </div>

        <!-- Photos Section -->
        <div class="section-card mb-5">
          <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
            <h3 class="section-title fw-bold mb-0">
              <i class="fa-regular fa-image"></i> الصور
            </h3>
            <button
              type="button"
              class="btn btn-custom-add py-2"
              (click)="fileInput.click()"
            >
              <i class="bi bi-cloud-upload me-2"></i> إضافة صور
            </button>
            <input
              #fileInput
              type="file"
              multiple
              accept="image/*"
              (change)="onFileSelected($event)"
              style="display: none;"
            />
          </div>

          @if (listingForm.get('photos')?.errors?.['minlength'] && (listingForm.get('photos')?.touched || listingForm.get('photos')?.dirty)) {
            <div class="text-danger small mb-3">الصور مطلوبة. يرجى إضافة صورة واحدة على الأقل.</div>
          }

          <!-- Photos Gallery -->
          <div class="row g-3" *ngIf="photos.length > 0" formArrayName="photos">
            <div
              class="col-6 col-md-4 col-lg-3"
              *ngFor="let photo of photos.controls; let i = index"
            >
              <div
                class="card border-0 shadow-sm h-100 position-relative overflow-hidden group-hover"
              >
                <img
                  [src]="photo.value"
                  class="card-img-top object-fit-cover"
                  style="height: 200px"
                  alt="Listing Photo"
                />
                <button
                  type="button"
                  class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2 rounded-circle shadow-sm d-flex align-items-center justify-content-center"
                  style="width: 32px; height: 32px"
                  (click)="removePhoto(i)"
                >
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="d-grid gap-2 col-md-6 mx-auto">
          <button
            type="submit"
            class="btn btn-primary btn-lg rounded-pill shadow fw-bold py-3"
            [disabled]="listingForm.invalid || isSubmitting"
          >
            <span
              *ngIf="isSubmitting"
              class="spinner-border spinner-border-sm me-2"
              role="status"
              aria-hidden="true"
            ></span>
            <i class="bi bi-check-lg me-2" *ngIf="!isSubmitting"></i>
            {{ isSubmitting ? 'جاري النشر...' : 'نشر الإعلان' }}
          </button>
        </div>
      </form>
    </div>
       
  </div>
</div>
