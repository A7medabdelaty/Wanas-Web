<div class="listing-details-page">
  <div class="container py-4">
    @if (listing) {
    <!-- Listing Photos Slider -->
    <div class="position-relative">
      <app-listing-photos [photos]="listing.listingPhotos"></app-listing-photos>
       @if (!listing.isActive) {
        <div class="inactive-badge-overlay position-absolute top-0 start-0 m-3 z-3">
          <span class="badge bg-secondary rounded-pill px-3 py-2 shadow-sm d-flex align-items-center gap-2">
            <i class="bi bi-pause-circle"></i> غير مفعل
          </span>
        </div>
      }
    </div>

    <!-- Listing Details -->
    <app-listing-details-card [listing]="listing" [averageRating]="averageRating" (reportListing)="onReportListing()"></app-listing-details-card>
    } @else {
    <div class="loading-container">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
      </div>
    </div>
  }

    <!-- Inactive Alert for Owner -->
    @if (listing && isOwner && !listing.isActive) {
      <div class="alert alert-warning d-flex align-items-center justify-content-between my-3" role="alert">
        <div>
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>الإعلان غير مفعل</strong> - لا يظهر للمستخدمين لأن جميع الأسرة محجوزة أو تم إيقافه يدوياً.
        </div>
        <button class="btn btn-sm btn-primary" (click)="onReactivateListing()" [disabled]="isReactivating">
          @if(isReactivating) { <span class="spinner-border spinner-border-sm me-1"></span> }
          إعادة تفعيل
        </button>
      </div>
    }

    <!-- Host Details Section (only show if listing is NOT owned by current user) -->
    @if (!isOwner && listing) {
    @if (loadingHost) {
    <div class="loading-container text-center my-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">جاري تحميل معلومات المضيف...</span>
      </div>
      <p class="mt-2 text-muted">جاري تحميل معلومات المضيف...</p>
    </div>
    } @else if (host) {
    <app-host-details [host]="host" [isListingInactive]="!listing.isActive" (sendMessage)="onCreateChat()"></app-host-details>
    }
    }



    @if (listing) {
    <!-- Reviews Section (Always show, but hide add button for owner) -->
    <app-reviews-section [listingId]="listing.id" [canAddReview]="!isOwner" [isOwner]="isOwner"
      (addReview)="onAddReview()"></app-reviews-section>

    <app-comment-section [comments]="listing.comments" (addComment)="onAddComment()"></app-comment-section>
    }

    @if (listing && isOwner) {
    <!-- Owner Actions (only show if listing IS owned by current user) -->
    <div class="owner-actions">
      <button class="btn update-btn me-3 rounded-pill" (click)="onUpdateListing()">
        <i class="bi bi-pencil-square me-2"></i>
        تعديل الإعلان
      </button>

      @if (!listing.isActive && listing.hasOccupiedBeds) {
      <button class="btn btn-secondary rounded-pill" disabled title="لا يمكن حذف الإعلان لوجود حجوزات نشطة">
        <i class="bi bi-trash me-2"></i>
        حذف الإعلان
      </button>
      } @else if (listing.isActive && listing.hasOccupiedBeds) {
      <button class="btn btn-outline-danger rounded-pill" (click)="onDeleteListing()">
        <i class="bi bi-pause-circle me-2"></i>
        إلغاء تفعيل الإعلان
      </button>
      } @else {
      <button class="btn delete-btn rounded-pill" (click)="onDeleteListing()">
        <i class="bi bi-trash me-2"></i>
        حذف الإعلان
      </button>
      }
    </div>
    }


@if (!isOwner && listing) {
    <!-- Book Now Button Section -->
    <div class="book-now-section">
      @if (loadingApprovalStatus) {
      <div class="approval-loading">
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        جاري التحقق من حالة الموافقة...
      </div>
      } @else {
      <!-- Modified Button Logic -->
      <button class="btn btn-book-now" 
              [disabled]="!paymentApproved || !listing.isActive" 
              (click)="onBookNow()"
              [title]="!listing.isActive ? 'الإعلان غير مفعل حالياً' : (paymentApproved ? 'احجز الآن' : 'في انتظار موافقة المالك على الدفع')">
        <i class="bi bi-calendar-check m-1"></i>
        {{ !listing.isActive ? 'غير متاح حالياً' : 'احجز الآن' }}
      </button>

      @if (!paymentApproved && listing.isActive) {
      <p class="approval-message">
        <i class="bi bi-info-circle me-2"></i>
        في انتظار موافقة المالك على الدفع
      </p>
      }
      
      @if (!listing.isActive) {
      <p class="text-danger mt-2 small fw-bold">
        <i class="bi bi-exclamation-circle me-1"></i>
        عذراً، هذا الإعلان غير مفعل أو محجوز بالكامل.
      </p>
      }

      }
    </div>
    }

  </div>
</div>