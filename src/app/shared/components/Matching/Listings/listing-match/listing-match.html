<div class="container my-5">
  
  <!-- Header: Updated for "Matching" Context -->
  <div class="d-flex justify-content-between align-items-end mb-4 px-2">
    <div>
      <h6 class="text-primary fw-bold text-uppercase ls-1 mb-2">
        <i class="bi bi-stars me-1"></i> بناءً على تفضيلاتك
      </h6>
      <h2 class="fw-bold display-6 m-0 text-dark font-cairo">أفضل الخيارات المناسبة لك</h2>
    </div>
    <!-- Hide 'View All' if loading or error -->
    <a href="#" class="text-decoration-none fw-bold small text-muted hover-primary" 
       *ngIf="!isLoading && !hasError && listings?.length">
      تصفح جميع النتائج <i class="bi bi-arrow-left"></i>
    </a>
  </div>

  <!-- 1. LOADING STATE (Skeleton UI) -->
  <div class="row g-4" *ngIf="isLoading">
    <div class="col-md-6 col-lg-4" *ngFor="let i of [1,2,3]">
      <div class="card border-0 h-100 shadow-sm" aria-hidden="true">
        <!-- Skeleton Image -->
        <div class="bg-secondary bg-opacity-10 placeholder-glow rounded-top" style="height: 200px; width: 100%;"></div>
        <div class="card-body p-4">
          <!-- Skeleton Text -->
          <h5 class="card-title placeholder-glow">
            <span class="placeholder col-6 rounded"></span>
          </h5>
          <p class="card-text placeholder-glow">
            <span class="placeholder col-4 rounded"></span>
            <span class="placeholder col-6 rounded ms-1"></span>
          </p>
          <div class="mt-3 placeholder-glow">
            <span class="placeholder col-12 rounded py-3"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 2. ERROR STATE -->
  <div class="text-center py-5" *ngIf="!isLoading && hasError">
    <div class="bg-danger bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
         style="width: 80px; height: 80px">
      <i class="bi bi-wifi-off fs-1 text-danger"></i>
    </div>
    <h4 class="fw-bold text-dark font-cairo">عذراً، حدثت مشكلة</h4>
    <p class="text-secondary">واجهنا صعوبة في جلب النتائج. تأكد من اتصالك وحاول مجدداً.</p>
    <button class="btn btn-outline-danger rounded-pill px-4 mt-2" (click)="loadListings()">
      <i class="bi bi-arrow-clockwise me-2"></i> تحديث الصفحة
    </button>
  </div>

  <!-- 3. DATA & EMPTY STATES (Using Angular 17 Control Flow) -->
  <div class="row g-4" *ngIf="!isLoading && !hasError">
    
    @for (listing of listings; track $index) {
      <div class="col-md-6 col-lg-4">
        
        <!-- Wrapper for positioning the score badge over the child component -->
        <div class="position-relative h-100">
          
          <!-- The Listing Card Component -->
          <app-listing-Card [listing]="listing" class="h-100 d-block"></app-listing-Card>

          <!-- Floating Score Badge (Improved Circular Design) -->
          <div class="position-absolute top-0 end-0 m-3 d-flex flex-column align-items-center justify-content-center shadow-lg"
               [ngClass]="'bg-' + getScoreColor(listing.score)"
               style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid rgba(255, 255, 255, 0.4); backdrop-filter: blur(2px);">
            
            <span class="fw-bold text-white lh-1" style="font-size: 1.1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
              {{ listing.score }}<span style="font-size: 0.7rem;">%</span>
            </span>
            <span class="text-white text-opacity-75" style="font-size: 0.6rem; font-weight: 500;">توافق</span>
            
          </div>

        </div>
      </div>
    } @empty {
      <!-- Empty State -->
      <div class="col-12 py-5 text-center">
        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
          <i class="bi bi-search fs-1 text-muted"></i>
        </div>
        <h5 class="fw-bold text-muted font-cairo">لم نعثر على السكن المثالي لك بعد</h5>
        <p class="text-secondary small font-cairo">من فضلك أكمل ملفك الشخصي للحصول على سكنك المثالي.</p>
      </div>
    }

  </div>
</div>