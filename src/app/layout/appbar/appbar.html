@if(userRole != 'admin'){
<nav class="appbar">

  <!-- APP START: Logo + Mobile Toggle -->
  <div class="app-start">
    <a routerLink="/" class="logo">
      <img src="/src/assets/test-logo.png" alt="Wanas Logo" height="40" onerror="this.style.display='none'" />
      <img src="images/icons/white.png" alt="Wanas Logo" height="80" class="navbar-icon" />
    </a>

    <!-- Mobile Toggle Button -->
    <button class="mobile-toggle" [class.active]="isMobileMenuOpen" (click)="toggleMobileMenu()"
      [attr.aria-expanded]="isMobileMenuOpen" [attr.aria-label]="isMobileMenuOpen ? 'إغلاق القائمة' : 'فتح القائمة'">
      <span class="hamburger"></span>
    </button>
  </div>

  <!-- APP CENTER: Navigation, Search & More Menu  -->
  <div class="app-center">

    <!-- Main Nav (Desktop + Mobile) -->
    <ul class="nav-links" [class.mobile-open]="isMobileMenuOpen">

      @for (item of filteredNavItems; track item.label) {
      <li class="nav-item">
        @if (item.link === '/') {
        <a [routerLink]="item.link" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
          (click)="isMobileMenuOpen = false">
          {{ item.label }}
        </a>
        } @else {
        <a [routerLink]="item.link" routerLinkActive="active" (click)="isMobileMenuOpen = false">
          {{ item.label }}
        </a>
        }
      </li>
      }

      <!-- Mobile User Buttons -->
      <li class="nav-item mobile-only" *ngIf="isMobileMenuOpen">
        <button *ngIf="!isGuest" (click)="logout()" class="btn-logout btn-mobile">تسجيل خروج</button>
        <button *ngIf="isGuest" routerLink="/login" class="btn-login btn-mobile">تسجيل دخول</button>
      </li>

      <!-- Mobile More Menu -->
      <!-- <ng-container *ngIf="isMobileMenuOpen && filteredMoreMenuOptions.length > 0">
        <li *ngFor="let item of filteredMoreMenuOptions" class="nav-item mobile-only">
          <a 
            [routerLink]="item.route"
            routerLinkActive="active"
            (click)="isMobileMenuOpen = false">
            {{ item.label }}
          </a>
        </li>
      </ng-container> -->

    </ul>

    <!-- Desktop More Menu -->
    <!-- <div class="more-menu-container desktop-only" *ngIf="filteredMoreMenuOptions.length > 0">
      <button class="btn-more" (click)="toggleMoreDropdown()" [class.active]="isMoreDropdownOpen">
        <span>المزيد</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </button>

      <div class="dropdown-menu more-dropdown" [class.show]="isMoreDropdownOpen">
        <a *ngFor="let option of filteredMoreMenuOptions"
           [routerLink]="option.route"
           class="dropdown-item"
           routerLinkActive="active"
           (click)="isMoreDropdownOpen = false">
          <span class="material-icons dropdown-icon">{{ option.icon }}</span>
          <span>{{ option.label }}</span>
        </a>
      </div>
    </div> -->

    <!-- Search (Desktop Only) -->
    <div class="search-container" *ngIf="!isGuest">
      <div class="search-input-wrapper visible">
        <input type="text" class="search-input" placeholder="ابحث عن سكن..." [(ngModel)]="searchKeyword"
          (keyup.enter)="performSearch()">
        <button class="search-btn" (click)="performSearch()">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
      </div>
    </div>

  </div>

  <!-- ░░░ USER ACTIONS (Desktop Only) ░░░ -->
  <div class="user-actions desktop-only">

    <!-- Guest View -->
    @if (isGuest) {
    <button routerLink="auth/login" class="btn-login">تسجيل دخول</button>
    <button routerLink="auth/register" class="btn-register">إنشاء حساب</button>
    }

    <!-- Logged-in View -->
    @else {

    <!-- Messages Icon -->
    <div class="messages-container">

      <div class="messages-btn" (click)="toggleMessages()" [class.active]="isMessagesOpen">
        <i class="fa-regular fa-comments"></i>

        @if (unreadMessagesCount > 0) {
        <span class="messages-badge">
          {{ unreadMessagesCount > 99 ? '99+' : unreadMessagesCount }}
        </span>
        }
      </div>

      <div class="messages-dropdown" [class.show]="isMessagesOpen" (click)="$event.stopPropagation()">
        <div class="messages-header">
          <h3>الرسائل</h3>
          <button class="view-all-btn" (click)="navigateToMessages()">
            عرض الكل
          </button>
        </div>

        <ul class="messages-list">
          @for (chat of recentChats$ | async; track chat.id) {
          <li class="message-item" [class.unread]="chat?.unreadCount && chat.unreadCount! > 0"
            (click)="onChatClick(chat.id.toString())">

            <div class="message-avatar">
              @if (getOtherParticipantPhoto(chat)) {
              <img [src]="getOtherParticipantPhoto(chat)" alt="User" class="avatar-image" />
              } @else {
              <i class="fa-solid fa-user"></i>
              }
            </div>

            <div class="message-content">
              <div class="message-header-row">
                <span class="chat-name">{{ chat.chatName || chat.name || 'محادثة' }}</span>
                @if (chat.unreadCount && chat.unreadCount > 0) {
                <span class="unread-count-badge">{{ chat.unreadCount }}</span>
                }
              </div>
              <span class="last-message">{{ chat.lastMessage?.content || 'لا توجد رسائل' }}</span>
              <span class="message-time">{{ chat.lastMessage?.sentAt | date:'short' }}</span>
            </div>

          </li>
          }

          <!-- Empty State -->
          @if (((recentChats$ | async) || []).length === 0) {
          <li class="messages-empty">
            <i class="fa-regular fa-comments"></i>
            <span>لا توجد محادثات حالياً</span>
          </li>
          }
        </ul>
      </div>
    </div>

    <!-- Notifications -->
    <div class="notification-container">

      <div class="notification-btn" (click)="toggleNotifications()" [class.active]="isNotificationsOpen">
        <i class="fa-regular fa-bell"></i>

        @if (unreadCount > 0) {
        <span class="notification-badge">
          {{ unreadCount > 99 ? '99+' : unreadCount }}
        </span>
        }
      </div>

      <div class="notification-dropdown" [class.show]="isNotificationsOpen" (click)="$event.stopPropagation()">
        <div class="notification-header">
          <h3>الإشعارات</h3>
          @if ((notifications$ | async)?.length) {
          <button class="mark-all-read" (click)="markAllNotificationsRead($event)">
            تحديد الكل كمقروء
          </button>
          }
        </div>

        <ul class="notification-list">
          @for (notification of notifications$ | async; track notification.id) {
          <li class="notification-item" [class.unread]="!notification.isRead"
            (click)="onNotificationClick(notification.id)">

            <div class="notification-icon" [ngClass]="notification.type.toLowerCase()">
              @switch (notification.type.toLowerCase()) {
              @case ('success') { <span>✓</span> }
              @case ('error') { <span>✕</span> }
              @case ('warning') { <span>⚠</span> }
              @default { <span>ⓘ</span> }
              }
            </div>

            <div class="notification-content">
              <span class="notification-title">{{ notification.title }}</span>
              <span class="notification-message">{{ notification.message }}</span>
              <span class="notification-time">{{ notification.createdAt | date:'short' }}</span>
            </div>

          </li>
          }

          <!-- Empty State -->
          @if ((notifications$ | async)?.length === 0) {
          <li class="notification-empty">
            <i class="fa-regular fa-bell"></i>
            <span>لا توجد إشعارات حالياً</span>
          </li>
          }
        </ul>
      </div>
    </div>

    <!-- User Profile -->
<div class="user-profile-dropdown">

  <div class="user-avatar" (click)="toggleDropdown()">
    @if (userImage) {
      <img [src]="userImage" alt="{{ userName }}" class="avatar-image" />
      <div *ngIf="isVerified" class="verified-badge small" title="موثق" data-bs-toggle="tooltip">
        <i class="bi bi-patch-check-fill"></i>
      </div>
    } @else {
      <span class="avatar-text">{{ userName.charAt(0) }}</span>
      <div *ngIf="isVerified" class="verified-badge small" title="موثق" data-bs-toggle="tooltip">
        <i class="bi bi-patch-check-fill"></i>
      </div>
    }
  </div>

      <div class="dropdown-menu" [class.show]="isDropdownOpen">

        <div class="dropdown-header-card">

          <div class="avatar-wrapper">
            <ng-container *ngIf="userImage; else defaultAvatar">
              <img [src]="userImage" alt="{{ userName }}" class="avatar-image" />
            </ng-container>
            <ng-template #defaultAvatar>
              <div class="avatar-placeholder">{{ userName.charAt(0) }}</div>
            </ng-template>

            <div *ngIf="isVerified" class="mini-badge" title="حساب موثق">
              <i class="bi bi-patch-check-fill"></i>
            </div>
          </div>

          <div class="user-info">

            <div class="name-row">
              <span class="user-name" title="{{ userName }}">{{ userName }}</span>

              <span class="role-badge" [ngClass]="{
                'owner-badge': profileType === 'مالك', 
                'renter-badge': profileType === 'مستأجر'
              }">
                {{ profileType }}
              </span>
            </div>

            <button (click)="navigateToProfile()" class="view-profile-link">
              عرض الملف الشخصي <i class="fas fa-chevron-left"></i>
            </button>
          </div>
        </div>

        <div class="dropdown-content">

          <button [routerLink]="hasSubmitted ? '/verification/status' : '/verification/upload'"
            class="dropdown-item verification-item" [ngClass]="isVerified ? 'verified' : 'unverified'"
            (click)="isDropdownOpen = false">

            <div class="icon-box">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V6l-8-4-8 4v6c0 6 8 10 8 10z"></path>
                <polyline points="9 12 12 15 17 10"></polyline>
              </svg>
            </div>

            <div class="item-text">
              <span class="title">{{ isVerified ? 'الحساب موثق' : 'توثيق الحساب' }}</span>
              <span class="subtitle">{{ isVerified ? 'هويتك مؤكدة' : 'أكمل التوثيق للأمان' }}</span>
            </div>

            <i *ngIf="isVerified" class="bi bi-check-circle-fill status-icon success"></i>
            <i *ngIf="!isVerified" class="bi bi-arrow-left status-icon action"></i>
          </button>

          <div class="divider"></div>

          <button (click)="logout()" class="dropdown-item logout-item">
            <div class="icon-box">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
            </div>
            <span class="title">تسجيل خروج</span>
          </button>
        </div>
      </div>
    </div>

    }

  </div>

</nav>

}